{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "functions": [],
  "parameters": {
    "cdb_subnet_name": {
      "type": "string",
      "defaultValue": "-cdb-subnet"
    },
    "virtualNetworks_vnet_name": {
      "defaultValue": "vnet",
      "type": "string"
    },
    "workspaces_laws_name": {
      "defaultValue": "laws",
      "type": "string"
    },
    "utcNowValue": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMDDHHmmssFFFF')]"
    },
    "linuxFxVersion": {
      "defaultValue": "dotnet|6.0",
      "type": "string"
    },
    "agency_abbreviation": {
      "type": "string"
    },
    "application": {
      "defaultValue": "ripa",
      "type": "string"
    },
    "sites_user_fa_name": {
      "defaultValue": "userprofile-fa",
      "type": "string"
    },
    "agency_ori": {
      "type": "string"
    },
    "user_tags": {
      "type": "Object",
      "defaultValue": {}
    },
    "fa_hostnamessl_ep_suff": {
      "defaultValue": ".azurewebsites.us",
      "type": "string"
    },
    "fa_hostnamessl_scm_ep_suff": {
      "defaultValue": ".scm.azurewebsites.us",
      "type": "string"
    },
    "serverfarms_userprofile_ASP_name": {
      "defaultValue": "userprofile-fa-asp",
      "type": "string"
    },
    "storageAccounts_functionssa_name": {
      "defaultValue": "fnsa",
      "type": "string"
    },
    "components_ai_name": {
      "defaultValue": "ai",
      "type": "string"
    },
    "storage_ep_suff": {
      "defaultValue": "core.usgovcloudapi.net",
      "type": "string"
    },
    "databaseAccounts_cdb_name": {
      "defaultValue": "cdb",
      "type": "string"
    },
    "dbaccount_sqlDb_user_container_name": {
      "type": "string",
      "defaultValue": "userprofile"
    },
    "dbaccount_sqlDb_name": {
      "type": "string",
      "defaultValue": "ripastops"
    },
    "vaults_kv_name": {
      "defaultValue": "kv",
      "type": "string"
    },
    "auth_app_id": {
      "type": "string"
    },
    "auth_fqdn": {
      "type": "string"
    },
    "auth_tenant_id": {
      "type": "string"
    },
    "use32BitWorkerProcess": {
      "defaultValue": false,
      "type": "bool"
    },
    "domain_fa_name": {
      "defaultValue": "domain-fa",
      "type": "string"
    },
    "serverfarms_domain_ASP_name": {
      "defaultValue": "domain-fa-asp",
      "type": "string"
    },
    "serverfarms_stop_ASP_name": {
      "defaultValue": "stop-fa-asp",
      "type": "string"
    },
    "serverfarms_submission_ASP_name": {
      "defaultValue": "submission-fa-asp",
      "type": "string"
    },
    "serverfarms_textanalytics_ASP_name": {
      "defaultValue": "textanalytics-fa-asp",
      "type": "string"
    },
    "stop_fa_name": {
      "defaultValue": "stop-fa",
      "type": "string"
    },
    "submission_fa_name": {
      "defaultValue": "submission-fa",
      "type": "string"
    },
    "textanalytics_fa_name": {
      "defaultValue": "textanalytics-fa",
      "type": "string"
    },
    "dbaccount_sqlDb_stop_container_name": {
      "type": "string",
      "defaultValue": "stop"
    },
    "dbaccount_sqlDb_stop_audit_container_name": {
      "type": "string",
      "defaultValue": "stopaudit"
    },
    "dbaccount_sqlDb_submission_container_name": {
      "type": "string",
      "defaultValue": "submission"
    },
    "submission_fa_config_storage_container_prefix_results": {
      "type": "string",
      "defaultValue": "result"
    },
    "submission_fa_config_storage_container_prefix_submissions": {
      "type": "string",
      "defaultValue": "submission"
    },
    "submission_fa_config_storage_container_prefix_cpra": {
      "type": "string",
      "defaultValue": "cpra"
    },
    "submission_fa_config_sftp_port": {
      "type": "int",
      "defaultValue": 22
    },
    "doj_sftp_disabled": {
      "type": "string",
      "defaultValue": "false"
    },
    "vaults_kv_secrets_key0": {
      "type": "string",
      "defaultValue": "ServiceBusConnection"
    },
    "vaults_kv_secrets_key1": {
      "type": "string",
      "defaultValue": "dbkey1"
    },
    "vaults_kv_secrets_key3": {
      "type": "string",
      "defaultValue": "ripaStorage"
    },
    "vaults_kv_secrets_key4": {
      "type": "string",
      "defaultValue": "takey1"
    },
    "vaults_kv_secrets_key6": {
      "type": "string",
      "defaultValue": "SftpKey"
    },
    "vaults_kv_secrets_key7": {
      "type": "string",
      "defaultValue": "SftpHost"
    },
    "vaults_kv_secrets_key8": {
      "type": "string",
      "defaultValue": "SftpPassword"
    },
    "vaults_kv_secrets_key9": {
      "type": "string",
      "defaultValue": "SftpUsername"
    },
    "vaults_kv_secrets_key10": {
      "type": "string",
      "defaultValue": "CosmosConnectionString"
    },
    "doj_environment": {
      "type": "string",
      "defaultValue": "PROD"
    },
    "submission_fa_config_sftp_input_path": {
      "type": "string",
      "defaultValue": "/incoming_to_DOJ/JSON/"
    },
    "submission_fa_config_sftp_output_path": {
      "type": "string",
      "defaultValue": "/responses_from_DOJ/"
    },
    "accounts_ripaTA_name": {
      "defaultValue": "ta",
      "type": "string"
    }
  },
  "variables": {
    "virtualNetworks_ripa_vnet_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('virtualNetworks_vnet_name'))]",
    "workspaces_ripa_laws_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('workspaces_laws_name'))]",
    "TA_Name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('accounts_ripaTA_name'))]",
    "textanalytics_fa_keyvault_referencestring": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key4'),')')]",
    "keyvault_secret_sftp_key": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key6'),')')]",
    "keyvault_secret_sftp_host": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key7'),')')]",
    "keyvault_secret_sftp_password": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key8'),')')]",
    "keyvault_secret_sftp_username": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key9'),')')]",
    "keyvault_secret_cosmos_connection_string": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key10'),')')]",
    "keyvault_secret_servicebus_connection_string": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key0'),')')]",
    "doj_inbound_folder": "[concat('/', parameters('doj_environment'), parameters('submission_fa_config_sftp_input_path'))]",
    "doj_outbound_folder": "[concat('/', parameters('doj_environment'), parameters('submission_fa_config_sftp_output_path'))]",
    "serverfarms_stop_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_stop_ASP_name'))]",
    "serverfarms_submission_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_submission_ASP_name'))]",
    "serverfarms_textanalytics_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_textanalytics_ASP_name'))]",
    "sites_ripa_stop_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('stop_fa_name'))]",
    "sites_ripa_submission_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('submission_fa_name'))]",
    "sites_ripa_textanalytics_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('textanalytics_fa_name'))]",
    "keyvault_secret_ripa_storage": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key3'),')')]",
    "serverfarms_domain_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_domain_ASP_name'))]",
    "sites_ripa_domain_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('domain_fa_name'))]",
    "vaults_ripa_kv_name": "[concat(parameters('agency_abbreviation'), parameters('application'), toLower(take(uniqueString(parameters('utcNowValue')), 3)), parameters('vaults_kv_name'))]",
    "user_fa_keyvault_referencestring": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key1'),')')]",
    "databaseAccounts_ripa_cdb_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('databaseAccounts_cdb_name'))]",
    "components_ripa_ai_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('components_ai_name'))]",
    "storageAccounts_ripafnsa_name": "[concat(parameters('agency_abbreviation'), replace(parameters('application'), '-', ''), parameters('storageAccounts_functionssa_name'))]",
    "serverfarms_userprofile_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_userprofile_ASP_name'))]",
    "sites_ripa_user_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('sites_user_fa_name'))]",
    "template_version": "#{TEMPLATE_VERSION}#",
    "default_tags": {
      "application": "ripa",
      "agency": "[parameters('agency_abbreviation')]",
      "agency_ori": "[parameters('agency_ori')]",
      "template_version": "[variables('template_version')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.DocumentDB/databaseAccounts",
      "apiVersion": "2020-09-01",
      "name": "[variables('databaseAccounts_ripa_cdb_name')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [],
      "kind": "GlobalDocumentDB",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.DocumentDB/databaseAccounts'), parameters('user_tags')['Microsoft.DocumentDB/databaseAccounts'], json('{}')))]",
      "properties": {
        "publicNetworkAccess": "Enabled",
        "enableAutomaticFailover": false,
        "enableMultipleWriteLocations": false,
        "isVirtualNetworkFilterEnabled": true,
        "virtualNetworkRules": [
          {
            "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_ripa_vnet_name'), concat(variables('virtualNetworks_ripa_vnet_name'), parameters('cdb_subnet_name')))]",
            "ignoreMissingVNetServiceEndpoint": true
          }
        ],
        "disableKeyBasedMetadataWriteAccess": false,
        "enableFreeTier": false,
        "enableAnalyticalStorage": false,
        "databaseAccountOfferType": "Standard",
        "consistencyPolicy": {
          "defaultConsistencyLevel": "Session",
          "maxIntervalInSeconds": 5,
          "maxStalenessPrefix": 100
        },
        "locations": [
          {
            "locationName": "[resourceGroup().location]",
            "provisioningState": "Succeeded",
            "failoverPriority": 0,
            "isZoneRedundant": false
          }
        ],
        "cors": [],
        "capabilities": [
          {
            "name": "EnableServerless"
          }
        ],
        "ipRules": [
          {
            "ipAddressOrRange": "0.0.0.0"
          }
        ],
        "backupPolicy": {
          "type": "Periodic",
          "periodicModeProperties": {
            "backupIntervalInMinutes": 60,
            "backupRetentionIntervalInHours": 168
          }
        }
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02-preview",
      "location": "[resourceGroup().location]",
      "name": "[variables('components_ripa_ai_name')]",
      "dependsOn": [],
      "kind": "web",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Insights/components'), parameters('user_tags')['Microsoft.Insights/components'], json('{}')))]",
      "properties": {
        "Application_Type": "web",
        "Flow_Type": "Redfield",
        "Request_Source": "IbizaAIExtension",
        "WorkspaceResourceId": "[resourceId('microsoft.operationalinsights/workspaces', variables('workspaces_ripa_laws_name'))]",
        "IngestionMode": "LogAnalytics",
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2017-04-18",
      "name": "[variables('TA_Name')]",
      "location": "[resourceGroup().location]",
      "sku": {
        "name": "S"
      },
      "kind": "TextAnalytics",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.CognitiveServices/accounts'), parameters('user_tags')['Microsoft.CognitiveServices/accounts'], json('{}')))]",
      "properties": {
        "customSubDomainName": "[variables('TA_Name')]",
        "networkAcls": {
          "defaultAction": "Allow",
          "virtualNetworkRules": [],
          "ipRules": []
        },
        "privateEndpointConnections": [],
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_user_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('components_ripa_ai_name'))]",
        "[resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))]"
      ],
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_user_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_user_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_userprofile_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "Account",
              "value": "[reference(resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))).documentEndpoint]"
            },
            {
              "name": "ContainerName",
              "value": "[parameters('dbaccount_sqlDb_user_container_name')]"
            },
            {
              "name": "DatabaseName",
              "value": "[parameters('dbaccount_sqlDb_name')]"
            },
            {
              "name": "Key",
              "value": "[variables('user_fa_keyvault_referencestring')]"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_domain_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('components_ripa_ai_name'))]",
        "[resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))]"
      ],
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_domain_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_domain_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_domain_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "RipaStorage",
              "value": "[variables('keyvault_secret_ripa_storage')]"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_stop_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('components_ripa_ai_name'))]",
        "[resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))]"
      ],
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_stop_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_stop_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_stop_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "Account",
              "value": "[reference(resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))).documentEndpoint]"
            },
            {
              "name": "StopContainerName",
              "value": "[parameters('dbaccount_sqlDb_stop_container_name')]"
            },
            {
              "name": "StopAuditContainerName",
              "value": "[parameters('dbaccount_sqlDb_stop_audit_container_name')]"
            },
            {
              "name": "UserProfileContainerName",
              "value": "[parameters('dbaccount_sqlDb_user_container_name')]"
            },
            {
              "name": "CosmosConnectionString",
              "value": "[variables('keyvault_secret_cosmos_connection_string')]"
            },
            {
              "name": "DatabaseName",
              "value": "[parameters('dbaccount_sqlDb_name')]"
            },
            {
              "name": "Key",
              "value": "[variables('user_fa_keyvault_referencestring')]"
            },
            {
              "name": "ORI",
              "value": "[parameters('agency_ori')]"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            },
            {
              "name": "RetryAttemps",
              "value": "3"
            },
            {
              "name": "RetryWait",
              "value": "1000"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_submission_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('components_ripa_ai_name'))]",
        "[resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))]"
      ],
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_submission_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_submission_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_submission_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobs.ServiceBusSubmissionConsumer.Disabled",
              "value": "true"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "Account",
              "value": "[reference(resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))).documentEndpoint]"
            },
            {
              "name": "DatabaseName",
              "value": "[parameters('dbaccount_sqlDb_name')]"
            },
            {
              "name": "Key",
              "value": "[variables('user_fa_keyvault_referencestring')]"
            },
            {
              "name": "ContainerNameSubmissions",
              "value": "[parameters('dbaccount_sqlDb_submission_container_name')]"
            },
            {
              "name": "ContainerNameStops",
              "value": "[parameters('dbaccount_sqlDb_stop_container_name')]"
            },
            {
              "name": "ContainerPrefixSubmissions",
              "value": "[parameters('submission_fa_config_storage_container_prefix_submissions')]"
            },
            {
              "name": "ContainerPrefixResults",
              "value": "[parameters('submission_fa_config_storage_container_prefix_results')]"
            },
            {
              "name": "ContainerPrefixCpra",
              "value": "[parameters('submission_fa_config_storage_container_prefix_cpra')]"
            },
            {
              "name": "UserProfileContainerName",
              "value": "[parameters('dbaccount_sqlDb_user_container_name')]"
            },
            {
              "name": "RipaStorage",
              "value": "[variables('keyvault_secret_ripa_storage')]"
            },
            {
              "name": "SftpInputPath",
              "value": "[variables('doj_inbound_folder')]"
            },
            {
              "name": "SftpOutputPath",
              "value": "[variables('doj_outbound_folder')]"
            },
            {
              "name": "SftpPort",
              "value": "[parameters('submission_fa_config_sftp_port')]"
            },
            {
              "name": "SftpHost",
              "value": "[variables('keyvault_secret_sftp_host')]"
            },
            {
              "name": "SftpUserName",
              "value": "[variables('keyvault_secret_sftp_username')]"
            },
            {
              "name": "SftpPassword",
              "value": "[variables('keyvault_secret_sftp_password')]"
            },
            {
              "name": "SftpKey",
              "value": "[variables('keyvault_secret_sftp_key')]"
            },
            {
              "name": "SftpDisabled",
              "value": "[parameters('doj_sftp_disabled')]"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            },
            {
              "name": "ServiceBusConnection",
              "value": "[variables('keyvault_secret_servicebus_connection_string')]"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true,
          "numberOfWorkers": 1
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_textanalytics_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "dependsOn": [
        "[resourceId('microsoft.insights/components', variables('components_ripa_ai_name'))]",
        "[resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))]",
        "[resourceId('Microsoft.CognitiveServices/accounts', variables('TA_Name'))]"
      ],
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_textanalytics_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_textanalytics_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_textanalytics_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~4"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "TextAnalyticsEndpoint",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('TA_Name'))).endpoint]"
            },
            {
              "name": "TextAnalyticsKey",
              "value": "[variables('textanalytics_fa_keyvault_referencestring')]"
            },
            {
              "name": "AllowedCategories",
              "value": "Age,Email,Person,PhoneNumber,Organization"
            },
            {
              "name": "MinimumConfidenceScore",
              "value": "80"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "[concat(toLower(take(uniqueString(parameters('utcNowValue')), 3)), 'cssa-app-update-runonce-deleteme-ifucme-dps')]",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_domain_fa_name'))]",
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_stop_fa_name'))]",
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_submission_fa_name'))]",
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_textanalytics_fa_name'))]",
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_user_fa_name'))]"
      ],
      "tags": {},
      "properties": {
        "forceUpdateTag": "newGuid()",
        "containerSettings": {
          "containerGroupName": "[concat(toLower(take(uniqueString(parameters('utcNowValue')), 3)), 'cssa-app-update-runonce-deleteme-ifucme-dps')]"
        },
        "storageAccountSettings": {
          "storageAccountName": "#{CSSA_STORAGE_ACCOUNT_NAME}#",
          "storageAccountKey": "#{CSSA_STORAGE_ACCOUNT_KEY}#"
        },
        "azPowerShellVersion": "3.0",
        "environmentVariables": [
          {
            "name": "CSSA_SP_APP_ID",
            "secureValue": "#{CSSA_SP_APP_ID}#"
          },
          {
            "name": "CSSA_SP_SECRET",
            "secureValue": "#{CSSA_SP_SECRET}#"
          },
          {
            "name": "CSSA_TENANT_ID",
            "value": "#{CSSA_TENANT_ID}#"
          },
          {
            "name": "APP_SUBSCRIPTION_ID",
            "value": "[subscription().subscriptionId]"
          },
          {
            "name": "APP_RESOURCE_GROUP_NAME",
            "value": "[resourceGroup().name]"
          },
          {
            "name": "DEPLOY_WEB_CONFIG_JSON",
            "value": "False"
          }
        ],
        "primaryScriptUri": "#{__TEMPLATE_VERSION_FORMATTED__-IMPORT-ALLRIPAAPPLICATIONS-PS1-SAS-URL}#",
        "supportingScriptUris": [
          "#{__TEMPLATE_VERSION_FORMATTED__-IMPORT-APIMAPIS-PSM1-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-NEW-FUNCTIONHOSTKEY-PSM1-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-NEW-RIPAAPIMBACKEND-PSM1-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-DOMAIN-ZIP-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-STOP-ZIP-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-SUBMISSION-ZIP-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-TEXTANALYTICS-ZIP-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-USERPROFILE-ZIP-SAS-URL}#",
          "#{__TEMPLATE_VERSION_FORMATTED__-UI-ZIP-SAS-URL}#"
        ],
        "timeout": "PT4H",
        "cleanupPreference": "OnExpiration",
        "retentionInterval": "PT4H"
      }
    }
  ],
  "outputs": {}
}
